function bDes=model_energyUndMatch(energy,beamPath)
%ENERGYUNDMATCH
%  ENERGYUNDMATCH(ENERGY,BEAMPATH)
%  - for CU_HXR beampath, calculates BDES for the HXR matching quads
%    (QUM1, QUM2, QUM3, and QUM4), and dump quads in UNDH line 
%    (valid over the range 3.0 - 17 GeV)
%  - for CU_SXR beampath, calculates BDES for the SXR matching quads
%    (QUM1B, QUM2B, QUM3B, QUM4B, QSXH16, QSXH19, QSXH21, and QSXH24)
%    (valid over the range 2.5 - 10 GeV (recommend staying at 3.4-10 GeV))
%
% Input arguments:
%   ENERGY   : Beam energy at undulator (GeV)
%   BEAMPATH : Beam path ('CU_HXR' or 'CU_SXR' only)
%
% Output arguments:
%   BDES : Value for the selected quadrupoles
%
% Compatibility: Version 7 and higher
% Called functions: none
%
% Author: Henrik Loos, SLAC
%
% --------------------------------------------------------------------
% Modified:
%   21-Jan-2021, M. Woodley
%     Restore full complement of  HXR undulators
%   20-Oct-2020, M. Woodley
%     Rematched for 5 missing HXR undulators (13:17)
%   12-Oct-2020, M. Woodley
%     Rematched for 7 missing HXR undulators (13:17,19,20)
%   06-Oct-2020, M. Woodley
%     Rematched for 9 missing HXR undulators (13:17,19,20,22,23);
%     increased minimum valid HXR energy to 3.0 GeV
%   13-Jun-2020, M. Woodley
%     Rematched for 10 missing HXR undulators (13:19,20,22,23)
% --------------------------------------------------------------------

% NOTE: each row of Bvals is a quadrupole; each column is an energy value

switch beamPath
  case 'CU_HXR'
  % label={'QUM1';'QUM2';'QUM3';'QUM4'};
    en=[3,3.2,3.4,3.6,3.8,4,4.5,5,5.5,6,7,8,9,10,11,12,13,14,15,16,17];
    
  % for full HXR undulator complement
    Bvals = ... % kG
      [  3.44158108275292,  5.07859122685842,  6.08051471063385,  7.00876046576889,  8.00398060129878,  8.99114278130639, 11.1139628882752, 12.8733760598607, 14.6688116629005, 16.5374350761553, 20.1133949195533, 23.2395241892203, 25.9962473673491, 28.4660364548063, 30.6617301848201, 32.5786591581086, 34.2060879417694, 35.5240365207266, 36.5261858036469, 37.2131827608605, 37.5784577937901; ...
        -4.83807006387599, -6.72281216074195, -7.86873294521852, -8.89695709848338, -9.92537077513057,-10.8958098770690 ,-12.9489453993616,-14.7161562544178,-16.4512272967401,-18.1278702277480,-20.9966009492500,-23.1894185036930,-24.8393828456245,-26.0210793887283,-26.7567282158219,-27.0780453922266,-27.0475137105791,-26.7865822967648,-26.4624391840038,-26.1590601324921,-25.7921815252924; ...
        16.3647691093603 , 17.2837612116099 , 18.1461502082431 , 18.9769939684831 , 19.6867913268954 , 20.2584423181346 , 21.4765895923372, 22.9191429654978, 24.2607660720591, 25.1775968969039, 25.4323990051438, 24.3995019367165, 22.6685013653919, 20.4692248876788, 17.9659174323538, 15.3763841552758, 13.0051228089320, 11.3325598259847, 10.8928949639153, 11.9073974841835, 14.1147122741720; ...
       -16.4172935392311 ,-16.7248273925930 ,-17.1755232554607 ,-17.6182105303604 ,-17.9823226904485 ,-18.2843913403265 ,-19.0092670508422,-19.8659473945806,-20.6267947874366,-21.1633219956614,-21.5553955738807,-21.4265020300357,-21.0022745980621,-20.3720951858235,-19.6278850868650,-18.9056952454968,-18.4067322017234,-18.4532595155813,-19.3950627684436,-21.3615089851527,-24.1604310816812; ...
      ];
  case 'CU_SXR'
  % label={'QUM1B';'QUM2B';'QUM3B';'QUM4B';'QSXH16';'QSXH19';'QSXH21';'QSXH24'};
    en=[2.5,2.6,2.7,2.8,2.9,3,3.2,3.4,3.6,3.8,4,4.5,5,5.5,6,7,8,9,10];

  % for full SXR undulator complement (NOTE: in present iteration, QUM1-3B are constant k (linear BDES))
    Bvals = ... % kG
      [  2.776314768,  2.887367359,  2.998419950,  3.109472540,  3.220525131,  3.331577722,  3.553682903,  3.775788085,  3.997893266,  4.219998448,  4.442103629,  4.997366583,  5.552629536,  6.107892490,  6.663155444,  7.773681351,  8.884207258,  9.994733166, 11.10525907 ; ...
        -1.157800974, -1.204113013, -1.250425052, -1.296737091, -1.343049130, -1.389361169, -1.481985247, -1.574609325, -1.667233403, -1.759857481, -1.852481559, -2.084041754, -2.315601949, -2.547162144, -2.778722339, -3.241842728, -3.704963118, -4.168083508, -4.631203898; ...
         3.425036032,  3.562037473,  3.699038915,  3.836040356,  3.973041797,  4.110043239,  4.384046121,  4.658049004,  4.932051886,  5.206054769,  5.480057651,  6.165064858,  6.850072064,  7.535079271,  8.220086477,  9.59010089 , 10.9601153  , 12.33012972 , 13.70014413 ; ...
        -4.473770719, -4.346567529, -4.307303776, -3.881919199, -4.289199056, -4.273664879, -4.109606729, -4.851081261, -5.916053314, -6.759157227, -7.439176672, -8.923347841,-10.28469666 ,-11.59427515 ,-12.87601937 ,-15.27540204 ,-17.60545645 ,-19.88081376 ,-22.10690132 ; ...
        -0.538008871, -0.636625354, -0.44809572 ,  0.384419412, -0.283743748, -0.111325727, -0.253891611,  1.089916136,  2.512735593,  3.534964097,  4.312674161,  6.002273294,  7.522995561,  8.965227911, 10.34106595 , 12.86612878 , 15.1738624  , 17.29062417 , 19.22715231 ; ...
        -3.789433996, -3.701040153, -4.172651716, -5.585857953, -5.076323951, -5.827860772, -6.454526386, -7.745331368, -8.653723351, -9.35099324 , -9.9534207  ,-11.41637344 ,-12.84369746 ,-14.24703055 ,-15.547067   ,-17.89756416 ,-19.87658481 ,-21.58283673 ,-23.05344348 ; ...
         8.755213835,  8.97248582 ,  9.403085291,  9.962140866, 10.18490379 , 10.69673829 , 11.45329943 , 12.19032873 , 12.73291302 , 13.24069775 , 13.75186432 , 14.97103305 , 16.08648393 , 17.08632027 , 17.93721767 , 19.27947977 , 20.14421762 , 20.64189818 , 20.87555945 ; ...
       -12.25240058 ,-12.23523387 ,-12.35831198 ,-11.86473038 ,-12.78345704 ,-12.63857393 ,-12.74180828 ,-12.82770684 ,-13.13910209 ,-13.61497349 ,-14.04198152 ,-15.1360743  ,-16.08198302 ,-16.85039813 ,-17.40995476 ,-18.06642431 ,-18.45087034 ,-18.72491292 ,-18.95258129 ; ...
      ];
  otherwise
    error('model_energyUndMatch: Bad beamPath specified.')
end

bDes=zeros(size(Bvals,1),numel(energy)); % existing format, quad by column, adding new format + energy by row (for plotting many values)
for k=1:size(Bvals,1)
  bDes(k,:)=spline(en,Bvals(k,:),energy);
end
