% psk_control

% get timing of all modulators and subboosters

pvtime = { 'TRIG:LI21:206:BEAMCODE1_TDES'
   % 'TRIG:LI21:201:BEAMCODE1_TDES'
   % 'TRIG:LI21:202:BEAMCODE1_TDES'
    'TRIG:LI21:203:BEAMCODE1_TDES'
    'TRIG:LI21:301:BEAMCODE1_TDES'
    'TRIG:LI21:302:BEAMCODE1_TDES'
    'TRIG:LI21:303:BEAMCODE1_TDES'
    'TRIG:LI21:401:BEAMCODE1_TDES'
    'TRIG:LI21:402:BEAMCODE1_TDES'
    
    'TRIG:LI22:206:BEAMCODE1_TDES'
    'TRIG:LI22:201:BEAMCODE1_TDES'
    'TRIG:LI22:202:BEAMCODE1_TDES'
    'TRIG:LI22:203:BEAMCODE1_TDES'
    'TRIG:LI22:301:BEAMCODE1_TDES'
    'TRIG:LI22:302:BEAMCODE1_TDES'
    'TRIG:LI22:303:BEAMCODE1_TDES'
    'TRIG:LI22:401:BEAMCODE1_TDES'
    'TRIG:LI22:402:BEAMCODE1_TDES'
    
    'TRIG:LI23:206:BEAMCODE1_TDES'
    'TRIG:LI23:201:BEAMCODE1_TDES'
    'TRIG:LI23:202:BEAMCODE1_TDES'
    'TRIG:LI23:203:BEAMCODE1_TDES'
    'TRIG:LI23:301:BEAMCODE1_TDES'
    'TRIG:LI23:302:BEAMCODE1_TDES'
    'TRIG:LI23:303:BEAMCODE1_TDES'
    'TRIG:LI23:401:BEAMCODE1_TDES'
    'TRIG:LI23:402:BEAMCODE1_TDES'
    
    'TRIG:LI24:206:BEAMCODE1_TDES'
    'TRIG:LI24:201:BEAMCODE1_TDES'
    'TRIG:LI24:202:BEAMCODE1_TDES'
    'TRIG:LI24:203:BEAMCODE1_TDES'
    'TRIG:LI24:301:BEAMCODE1_TDES'
    'TRIG:LI24:302:BEAMCODE1_TDES'
    'TRIG:LI24:303:BEAMCODE1_TDES'
  %  'TRIG:LI24:401:BEAMCODE1_TDES'
  %  'TRIG:LI24:402:BEAMCODE1_TDES'
  'ACCL:LI24:100:KLY_C_1_TDES'
  'ACCL:LI24:200:KLY_C_1_TDES'
  'ACCL:LI24:300:KLY_C_1_TDES'
    
    'TRIG:LI25:206:BEAMCODE1_TDES'
    'TRIG:LI25:201:BEAMCODE1_TDES'
    'TRIG:LI25:202:BEAMCODE1_TDES'
    'TRIG:LI25:203:BEAMCODE1_TDES'
    'TRIG:LI25:301:BEAMCODE1_TDES'
    'TRIG:LI25:302:BEAMCODE1_TDES'
    'TRIG:LI25:303:BEAMCODE1_TDES'
    'TRIG:LI25:401:BEAMCODE1_TDES'
    'TRIG:LI25:402:BEAMCODE1_TDES'
    
    'TRIG:LI26:206:BEAMCODE1_TDES'
    'TRIG:LI26:201:BEAMCODE1_TDES'
    'TRIG:LI26:202:BEAMCODE1_TDES'
    'TRIG:LI26:202:BEAMCODE1_TDES'     % Li26-3 is MR
    'TRIG:LI26:301:BEAMCODE1_TDES'
    'TRIG:LI26:302:BEAMCODE1_TDES'
    'TRIG:LI26:303:BEAMCODE1_TDES'
    'TRIG:LI26:401:BEAMCODE1_TDES'
    'TRIG:LI26:402:BEAMCODE1_TDES'
    
    'TRIG:LI27:206:BEAMCODE1_TDES'
    'TRIG:LI27:201:BEAMCODE1_TDES'
    'TRIG:LI27:202:BEAMCODE1_TDES'
    'TRIG:LI27:203:BEAMCODE1_TDES'
    'TRIG:LI27:301:BEAMCODE1_TDES'
    'TRIG:LI27:302:BEAMCODE1_TDES'
    'TRIG:LI27:303:BEAMCODE1_TDES'
    'TRIG:LI27:401:BEAMCODE1_TDES'
    'TRIG:LI27:402:BEAMCODE1_TDES'
    
    'TRIG:LI28:206:BEAMCODE1_TDES'
    'TRIG:LI28:201:BEAMCODE1_TDES'
    'TRIG:LI28:202:BEAMCODE1_TDES'    % was 203? Li28-2 is special
    'TRIG:LI28:203:BEAMCODE1_TDES'
    'TRIG:LI28:301:BEAMCODE1_TDES'
    'TRIG:LI28:302:BEAMCODE1_TDES'
    'TRIG:LI28:303:BEAMCODE1_TDES'
    'TRIG:LI28:401:BEAMCODE1_TDES'
    'TRIG:LI28:402:BEAMCODE1_TDES'
    
    'TRIG:LI29:206:BEAMCODE1_TDES'
    'TRIG:LI29:201:BEAMCODE1_TDES'
    'TRIG:LI29:202:BEAMCODE1_TDES'
    'TRIG:LI29:203:BEAMCODE1_TDES'
    'TRIG:LI29:301:BEAMCODE1_TDES'
    'TRIG:LI29:302:BEAMCODE1_TDES'
    'TRIG:LI29:303:BEAMCODE1_TDES'
    'TRIG:LI29:401:BEAMCODE1_TDES'
    'TRIG:LI29:402:BEAMCODE1_TDES'
    
    'TRIG:LI30:206:BEAMCODE1_TDES'
    'TRIG:LI30:201:BEAMCODE1_TDES'
    'TRIG:LI30:202:BEAMCODE1_TDES'
    'TRIG:LI30:203:BEAMCODE1_TDES'
    'TRIG:LI30:301:BEAMCODE1_TDES'
    'TRIG:LI30:302:BEAMCODE1_TDES'
    'TRIG:LI30:303:BEAMCODE1_TDES'
    'TRIG:LI30:401:BEAMCODE1_TDES'
    'TRIG:LI30:402:BEAMCODE1_TDES'
    };

% BC2:
pvtime2 = { 'TRIG:LI21:206:BEAMCODE2_TDES'
   % 'TRIG:LI21:201:BEAMCODE2_TDES'
   % 'TRIG:LI21:202:BEAMCODE2_TDES'
    'TRIG:LI21:203:BEAMCODE2_TDES'
    'TRIG:LI21:301:BEAMCODE2_TDES'
    'TRIG:LI21:302:BEAMCODE2_TDES'
    'TRIG:LI21:303:BEAMCODE2_TDES'
    'TRIG:LI21:401:BEAMCODE2_TDES'
    'TRIG:LI21:402:BEAMCODE2_TDES'
    
    'TRIG:LI22:206:BEAMCODE2_TDES'
    'TRIG:LI22:201:BEAMCODE2_TDES'
    'TRIG:LI22:202:BEAMCODE2_TDES'
    'TRIG:LI22:203:BEAMCODE2_TDES'
    'TRIG:LI22:301:BEAMCODE2_TDES'
    'TRIG:LI22:302:BEAMCODE2_TDES'
    'TRIG:LI22:303:BEAMCODE2_TDES'
    'TRIG:LI22:401:BEAMCODE2_TDES'
    'TRIG:LI22:402:BEAMCODE2_TDES'
    
    'TRIG:LI23:206:BEAMCODE2_TDES'
    'TRIG:LI23:201:BEAMCODE2_TDES'
    'TRIG:LI23:202:BEAMCODE2_TDES'
    'TRIG:LI23:203:BEAMCODE2_TDES'
    'TRIG:LI23:301:BEAMCODE2_TDES'
    'TRIG:LI23:302:BEAMCODE2_TDES'
    'TRIG:LI23:303:BEAMCODE2_TDES'
    'TRIG:LI23:401:BEAMCODE2_TDES'
    'TRIG:LI23:402:BEAMCODE2_TDES'
    
    'TRIG:LI24:206:BEAMCODE2_TDES'
    'TRIG:LI24:201:BEAMCODE2_TDES'
    'TRIG:LI24:202:BEAMCODE2_TDES'
    'TRIG:LI24:203:BEAMCODE2_TDES'
    'TRIG:LI24:301:BEAMCODE2_TDES'
    'TRIG:LI24:302:BEAMCODE2_TDES'
    'TRIG:LI24:303:BEAMCODE2_TDES'
  %  'TRIG:LI24:401:BEAMCODE2_TDES'
  %  'TRIG:LI24:402:BEAMCODE2_TDES'
  'ACCL:LI24:100:KLY_C_1_TDES'
  'ACCL:LI24:200:KLY_C_1_TDES'
  'ACCL:LI24:300:KLY_C_1_TDES'
    
    'TRIG:LI25:206:BEAMCODE2_TDES'
    'TRIG:LI25:201:BEAMCODE2_TDES'
    'TRIG:LI25:202:BEAMCODE2_TDES'
    'TRIG:LI25:203:BEAMCODE2_TDES'
    'TRIG:LI25:301:BEAMCODE2_TDES'
    'TRIG:LI25:302:BEAMCODE2_TDES'
    'TRIG:LI25:303:BEAMCODE2_TDES'
    'TRIG:LI25:401:BEAMCODE2_TDES'
    'TRIG:LI25:402:BEAMCODE2_TDES'
    
    'TRIG:LI26:206:BEAMCODE2_TDES'
    'TRIG:LI26:201:BEAMCODE2_TDES'
    'TRIG:LI26:202:BEAMCODE2_TDES'
    'TRIG:LI26:202:BEAMCODE2_TDES'     % Li26-3 is MR
    'TRIG:LI26:301:BEAMCODE2_TDES'
    'TRIG:LI26:302:BEAMCODE2_TDES'
    'TRIG:LI26:303:BEAMCODE2_TDES'
    'TRIG:LI26:401:BEAMCODE2_TDES'
    'TRIG:LI26:402:BEAMCODE2_TDES'
    
    'TRIG:LI27:206:BEAMCODE2_TDES'
    'TRIG:LI27:201:BEAMCODE2_TDES'
    'TRIG:LI27:202:BEAMCODE2_TDES'
    'TRIG:LI27:203:BEAMCODE2_TDES'
    'TRIG:LI27:301:BEAMCODE2_TDES'
    'TRIG:LI27:302:BEAMCODE2_TDES'
    'TRIG:LI27:303:BEAMCODE2_TDES'
    'TRIG:LI27:401:BEAMCODE2_TDES'
    'TRIG:LI27:402:BEAMCODE2_TDES'
    
    'TRIG:LI28:206:BEAMCODE2_TDES'
    'TRIG:LI28:201:BEAMCODE2_TDES'
    'TRIG:LI28:202:BEAMCODE2_TDES'    % was 203? Li28-2 is special
    'TRIG:LI28:203:BEAMCODE2_TDES'
    'TRIG:LI28:301:BEAMCODE2_TDES'
    'TRIG:LI28:302:BEAMCODE2_TDES'
    'TRIG:LI28:303:BEAMCODE2_TDES'
    'TRIG:LI28:401:BEAMCODE2_TDES'
    'TRIG:LI28:402:BEAMCODE2_TDES'
    
    'TRIG:LI29:206:BEAMCODE2_TDES'
    'TRIG:LI29:201:BEAMCODE2_TDES'
    'TRIG:LI29:202:BEAMCODE2_TDES'
    'TRIG:LI29:203:BEAMCODE2_TDES'
    'TRIG:LI29:301:BEAMCODE2_TDES'
    'TRIG:LI29:302:BEAMCODE2_TDES'
    'TRIG:LI29:303:BEAMCODE2_TDES'
    'TRIG:LI29:401:BEAMCODE2_TDES'
    'TRIG:LI29:402:BEAMCODE2_TDES'
    
    'TRIG:LI30:206:BEAMCODE2_TDES'
    'TRIG:LI30:201:BEAMCODE2_TDES'
    'TRIG:LI30:202:BEAMCODE2_TDES'
    'TRIG:LI30:203:BEAMCODE2_TDES'
    'TRIG:LI30:301:BEAMCODE2_TDES'
    'TRIG:LI30:302:BEAMCODE2_TDES'
    'TRIG:LI30:303:BEAMCODE2_TDES'
    'TRIG:LI30:401:BEAMCODE2_TDES'
    'TRIG:LI30:402:BEAMCODE2_TDES'
    };

pv_SBST_TDLY={'SBST:LI21:1:TDLY_DES'
    'SBST:LI22:1:TDLY_DES'
    'SBST:LI23:1:TDLY_DES'
    'SBST:LI24:1:TDLY_DES'
    'SBST:LI25:1:TDLY_DES'
    'SBST:LI26:1:TDLY_DES'
    'SBST:LI27:1:TDLY_DES'
    'SBST:LI28:1:TDLY_DES'
    'SBST:LI29:1:TDLY_DES'
    'SBST:LI30:1:TDLY_DES'};
    
path(path,'/home/physics/decker/matlab/toolbox')
load  PSK_t00 
load  PSK_t7496
load  PSK_tstag

load TDLY_00

psk_t00 = psk_t0;
sbt00 =sbt;
sbt0=lcaGet(pv_SBST_TDLY);

psk_t0 = lcaGet(pvtime);
L2_t0 = psk_t0(1:35);
L3_t0 = psk_t0(36:89);

psk_t02 = lcaGet(pvtime2);   % not used yet
L2_t02 = psk_t02(1:35);
L3_t02 = psk_t02(36:89);

L2td0=sbt0(1:4);
L3td0=sbt0(5:10);

stag2 = [2 2 2 2 2 2 2   4 4 4 4 4  4 4 4 4   6 6 6 6 6  6 6 6 6   8 8 8 8 8  8 8  8 8 8];
stag3 = [0 0 0 0 0  0 0 0 0   2 2 2 2 2  2 2 2 2   3 3 3 3 3  3 3 3 3    ... 
         5 5 5 5 5  5 5 5 5   6 6 6 6 6  6 6 6 6   8 8 8 8 8  8 8 8 8 ];
% missing if it is already stagged !!
already_stag = 0;
if L2_t0(10) - L2_t0(2)  == 2
    already_stag = 1;
     stag2 = zeros(size(stag2));
     stag3 = zeros(size(stag3));
end

ii = lcaGet('SIOC:SYS0:ML03:AO843');
psk2old = 0;
psk3old = 0;
while ii == 1     
     
psk2f = lcaGet('SIOC:SYS0:ML03:AO840');
psk3f = lcaGet('SIOC:SYS0:ML03:AO841');

L2t =L2_t0 + stag2' +psk2f;
L3t =L3_t0 + stag3' +psk3f;

L23t = ([L2t' L3t'])';

L2td = L2td0 + psk2f/1000;
L3td = L3td0 + psk3f/1000;

L23td= ([L2td' L3td']);

if ((psk2f ~=psk2old) || (psk3f ~=psk3old))
    lcaPut(pvtime,L23t)         % should be enclosed in an if statement and only change when different
    lcaPut(pvtime2,L23t)  
    lcaPut(pv_SBST_TDLY,L23td')
    
    psk2old = psk2f;
    psk3old = psk3f;
end
    

ii = lcaGet('SIOC:SYS0:ML03:AO843');

pause(0.1)

end

if ii == 0
  lcaPut(pvtime,psk_t0)
  lcaPut(pvtime2,psk_t0)
  display(' All PSK times restored')
  lcaPut(pv_SBST_TDLY,sbt0)
  pause(0.1)
end

if ii == 2
   lcaPut(pvtime, psk_t7496) 
   lcaPut(pvtime2,psk_t7496)
   display(' All PSK times restored to -7496 ns for modulators -10190 ns for SBST values')
   lcaPut(pv_SBST_TDLY,sbt0)
end

if ii == 3
   lcaPut(pvtime,psk_t00) 
   lcaPut(pvtime2,psk_t00) 
   display(' All PSK times restored to 08Jul2016 values')
   lcaPut(pv_SBST_TDLY,sbt00)      % 24-Apr-2017 values for TDLYs
end

if ii == 4
   lcaPut(pvtime,psk_tstag) 
   lcaPut(pvtime2,psk_tstag) 
   display(' All PSK times set to staggered mode')
   lcaPut(pv_SBST_TDLY,sbt0)
end






