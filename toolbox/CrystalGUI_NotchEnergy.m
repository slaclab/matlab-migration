function [photon_energy_ev, lambda_m, angolo]=CrystalGUI_NotchEnergy(T_S,Y_S,Reflection, Offset_Vector, material, norder)

% T_S is the value set in the machine for theta
% Y_S is the value set in the machine for yaw

%Offset_Vector
% Errors in the initial displacement of the Crystal (How planes are rotated in respect to how it was intended when T_S=0 and Y_S =0)
% 1: eRyY (Apply a y-rotation first)
% 2: eRzR (Apply a z-rotation second)
% 3: eRxP (Apply a x-rotation last)
% Errors in the rotation axis of the Rotational Stage
% 4: eyRA (Axis should be x, apply a small y rotation first) 
% 5: ezRA (Apply a small z rotation last)
% Errors in the rotation axis of the Yaw Stage
% 6: exYA (Axis should be -y for pitch = 90 deg, +z for pitch =0 deg, apply a small x rotation first)
% 7: ezRA (Apply a small z rotation last)

% Errors in the readings
% 8: Tmis error in the theta reading. The actual value is
% Theta_Machine = Theta_Readout + Theta_MisReading
% 9: Ymis error in the yaw reading. The actual value is 
% Yaw_Machine = Yaw_Readout + Yaw_MisReading

% Usage 1 T_S and Y_S are vectors (any length), Reflections is a three integers vector
% Usage 2 T_S and Y_S are vectors (same length), Reflections is a matrix of
% (N,3) reflections.

% Offset_Vector.Y_Rotation_Error= 0;
% Offset_Vector.Z_Rotation_Error= 0;
% Offset_Vector.X_Rotation_Error= 0;
% 
% Offset_Vector.Y_Rotation_ThetaAxis=0;
% Offset_Vector.Z_Rotation_ThetaAxis=0;
% 
% Offset_Vector.X_Rotation_YawAxis=0;
% Offset_Vector.Z_Rotation_YawAxis=0;
% 
% Offset_Vector.Theta_Misreading=0;
% Offset_Vector.Yaw_Misreading=0;



eRyY=Offset_Vector.Y_Rotation_Error;
eRzR=Offset_Vector.Z_Rotation_Error;
eRxP=Offset_Vector.X_Rotation_Error;

eyRA=Offset_Vector.Y_Rotation_ThetaAxis;
ezRA=Offset_Vector.Z_Rotation_ThetaAxis;

exYA=Offset_Vector.X_Rotation_YawAxis;
ezYA=Offset_Vector.Z_Rotation_YawAxis;

TMis=Offset_Vector.Theta_Misreading;
YMis=Offset_Vector.Yaw_Misreading;

hplanck=4.135667516*10^-15;
cluce=299792458;

if(nargin<5)
    material='diamond';
end

switch(material)
    case 'diamond'
        Lattice=0.356683*10^-9;
    case 'silicon'
        Lattice=0.54311*10^-9;
    otherwise
        Lattice=0.356683*10^-9;
end

if(numel(Reflection)==3)
    if(iscolumn(T_S))
        T_S=transpose(T_S);
    end
    if(isrow(Y_S))
        Y_S=transpose(Y_S);
    end
    h=Reflection(1); k=Reflection(2); l=Reflection(3);
    Yv=((Y_S+YMis)/180*pi)*ones(1,length(T_S));
    Tv=ones(length(Y_S),1)*((T_S+TMis)/180*pi);
    
    angolo=acos((1./sqrt(h.^2+k.^2+l.^2)).*(k.*(-sin(pi./4+eRzR).*((-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)-cos(eyRA).*sin(ezRA).*sin(Tv)).*(cos(Yv)+(1-cos(Yv)).*(cos(exYA).*(cos(Tv)+(1-cos(Tv)).*sin(eyRA).^2)-cos(ezYA).*sin(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)+cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)-cos(eyRA).*sin(ezRA).*sin(Tv))).^2)+(cos(eyRA).^2.*cos(ezRA).*(1-cos(Tv)).*sin(ezRA)-sin(eyRA).*sin(Tv)).*((1-cos(Yv)).*(-cos(ezYA).*sin(exYA).*(cos(Tv)+cos(eyRA).^2.*(1-cos(Tv)).*sin(ezRA).^2)+cos(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)-cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(cos(eyRA).^2.*cos(ezRA).*(1-cos(Tv)).*sin(ezRA)-sin(eyRA).*sin(Tv))).*(cos(exYA).*(cos(Tv)+(1-cos(Tv)).*sin(eyRA).^2)-cos(ezYA).*sin(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)+cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)-cos(eyRA).*sin(ezRA).*sin(Tv)))+(-cos(exYA).*cos(eyRA).*cos(ezRA).*sin(eyRA)+cos(exYA).*cos(eyRA).*cos(ezRA).*cos(Tv).*sin(eyRA)-cos(eyRA).^2.*cos(ezRA).*cos(ezYA).*sin(exYA).*sin(ezRA)+cos(eyRA).^2.*cos(ezRA).*cos(ezYA).*cos(Tv).*sin(exYA).*sin(ezRA)+cos(eyRA).^2.*cos(ezRA).^2.*sin(exYA).*sin(ezYA)+cos(Tv).*sin(exYA).*sin(ezYA)-cos(eyRA).^2.*cos(ezRA).^2.*cos(Tv).*sin(exYA).*sin(ezYA)-cos(ezYA).*sin(exYA).*sin(eyRA).*sin(Tv)+cos(exYA).*cos(eyRA).*sin(ezRA).*sin(Tv)).*sin(Yv))+(cos(eyRA).^2.*cos(ezRA).^2.*(1-cos(Tv))+cos(Tv)).*((1-cos(Yv)).*(cos(exYA).*(cos(Tv)+(1-cos(Tv)).*sin(eyRA).^2)-cos(ezYA).*sin(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)+cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)-cos(eyRA).*sin(ezRA).*sin(Tv))).*((cos(eyRA).^2.*cos(ezRA).^2.*(1-cos(Tv))+cos(Tv)).*sin(exYA).*sin(ezYA)-cos(ezYA).*sin(exYA).*(cos(eyRA).^2.*cos(ezRA).*(1-cos(Tv)).*sin(ezRA)+sin(eyRA).*sin(Tv))+cos(exYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)+cos(eyRA).*sin(ezRA).*sin(Tv)))+(cos(ezYA).*cos(Tv).*sin(exYA)+cos(exYA).*cos(eyRA).*sin(eyRA).*sin(ezRA)-cos(exYA).*cos(eyRA).*cos(Tv).*sin(eyRA).*sin(ezRA)+cos(eyRA).^2.*cos(ezYA).*sin(exYA).*sin(ezRA).^2-cos(eyRA).^2.*cos(ezYA).*cos(Tv).*sin(exYA).*sin(ezRA).^2-cos(eyRA).^2.*cos(ezRA).*sin(exYA).*sin(ezRA).*sin(ezYA)+cos(eyRA).^2.*cos(ezRA).*cos(Tv).*sin(exYA).*sin(ezRA).*sin(ezYA)+cos(exYA).*cos(eyRA).*cos(ezRA).*sin(Tv)+sin(exYA).*sin(eyRA).*sin(ezYA).*sin(Tv)).*sin(Yv)))+cos(pi./4+eRzR).*sin(eRxP).*((-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)+cos(eyRA).*cos(ezRA).*sin(Tv)).*(cos(Yv)+(1-cos(Yv)).*(cos(exYA).*(cos(Tv)+(1-cos(Tv)).*sin(eyRA).^2)-cos(ezYA).*sin(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)+cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)-cos(eyRA).*sin(ezRA).*sin(Tv))).^2)+(cos(Tv)+cos(eyRA).^2.*(1-cos(Tv)).*sin(ezRA).^2).*((1-cos(Yv)).*(-cos(ezYA).*sin(exYA).*(cos(Tv)+cos(eyRA).^2.*(1-cos(Tv)).*sin(ezRA).^2)+cos(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)-cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(cos(eyRA).^2.*cos(ezRA).*(1-cos(Tv)).*sin(ezRA)-sin(eyRA).*sin(Tv))).*(cos(exYA).*(cos(Tv)+(1-cos(Tv)).*sin(eyRA).^2)-cos(ezYA).*sin(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)+cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)-cos(eyRA).*sin(ezRA).*sin(Tv)))+(-cos(exYA).*cos(eyRA).*cos(ezRA).*sin(eyRA)+cos(exYA).*cos(eyRA).*cos(ezRA).*cos(Tv).*sin(eyRA)-cos(eyRA).^2.*cos(ezRA).*cos(ezYA).*sin(exYA).*sin(ezRA)+cos(eyRA).^2.*cos(ezRA).*cos(ezYA).*cos(Tv).*sin(exYA).*sin(ezRA)+cos(eyRA).^2.*cos(ezRA).^2.*sin(exYA).*sin(ezYA)+cos(Tv).*sin(exYA).*sin(ezYA)-cos(eyRA).^2.*cos(ezRA).^2.*cos(Tv).*sin(exYA).*sin(ezYA)-cos(ezYA).*sin(exYA).*sin(eyRA).*sin(Tv)+cos(exYA).*cos(eyRA).*sin(ezRA).*sin(Tv)).*sin(Yv))+(cos(eyRA).^2.*cos(ezRA).*(1-cos(Tv)).*sin(ezRA)+sin(eyRA).*sin(Tv)).*((1-cos(Yv)).*(cos(exYA).*(cos(Tv)+(1-cos(Tv)).*sin(eyRA).^2)-cos(ezYA).*sin(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)+cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)-cos(eyRA).*sin(ezRA).*sin(Tv))).*((cos(eyRA).^2.*cos(ezRA).^2.*(1-cos(Tv))+cos(Tv)).*sin(exYA).*sin(ezYA)-cos(ezYA).*sin(exYA).*(cos(eyRA).^2.*cos(ezRA).*(1-cos(Tv)).*sin(ezRA)+sin(eyRA).*sin(Tv))+cos(exYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)+cos(eyRA).*sin(ezRA).*sin(Tv)))+(cos(ezYA).*cos(Tv).*sin(exYA)+cos(exYA).*cos(eyRA).*sin(eyRA).*sin(ezRA)-cos(exYA).*cos(eyRA).*cos(Tv).*sin(eyRA).*sin(ezRA)+cos(eyRA).^2.*cos(ezYA).*sin(exYA).*sin(ezRA).^2-cos(eyRA).^2.*cos(ezYA).*cos(Tv).*sin(exYA).*sin(ezRA).^2-cos(eyRA).^2.*cos(ezRA).*sin(exYA).*sin(ezRA).*sin(ezYA)+cos(eyRA).^2.*cos(ezRA).*cos(Tv).*sin(exYA).*sin(ezRA).*sin(ezYA)+cos(exYA).*cos(eyRA).*cos(ezRA).*sin(Tv)+sin(exYA).*sin(eyRA).*sin(ezYA).*sin(Tv)).*sin(Yv)))-cos(eRxP).*cos(pi./4+eRzR).*((cos(Tv)+(1-cos(Tv)).*sin(eyRA).^2).*(cos(Yv)+(1-cos(Yv)).*(cos(exYA).*(cos(Tv)+(1-cos(Tv)).*sin(eyRA).^2)-cos(ezYA).*sin(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)+cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)-cos(eyRA).*sin(ezRA).*sin(Tv))).^2)+(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)-cos(eyRA).*cos(ezRA).*sin(Tv)).*((1-cos(Yv)).*(-cos(ezYA).*sin(exYA).*(cos(Tv)+cos(eyRA).^2.*(1-cos(Tv)).*sin(ezRA).^2)+cos(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)-cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(cos(eyRA).^2.*cos(ezRA).*(1-cos(Tv)).*sin(ezRA)-sin(eyRA).*sin(Tv))).*(cos(exYA).*(cos(Tv)+(1-cos(Tv)).*sin(eyRA).^2)-cos(ezYA).*sin(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)+cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)-cos(eyRA).*sin(ezRA).*sin(Tv)))+(-cos(exYA).*cos(eyRA).*cos(ezRA).*sin(eyRA)+cos(exYA).*cos(eyRA).*cos(ezRA).*cos(Tv).*sin(eyRA)-cos(eyRA).^2.*cos(ezRA).*cos(ezYA).*sin(exYA).*sin(ezRA)+cos(eyRA).^2.*cos(ezRA).*cos(ezYA).*cos(Tv).*sin(exYA).*sin(ezRA)+cos(eyRA).^2.*cos(ezRA).^2.*sin(exYA).*sin(ezYA)+cos(Tv).*sin(exYA).*sin(ezYA)-cos(eyRA).^2.*cos(ezRA).^2.*cos(Tv).*sin(exYA).*sin(ezYA)-cos(ezYA).*sin(exYA).*sin(eyRA).*sin(Tv)+cos(exYA).*cos(eyRA).*sin(ezRA).*sin(Tv)).*sin(Yv))+(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)+cos(eyRA).*sin(ezRA).*sin(Tv)).*((1-cos(Yv)).*(cos(exYA).*(cos(Tv)+(1-cos(Tv)).*sin(eyRA).^2)-cos(ezYA).*sin(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)+cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)-cos(eyRA).*sin(ezRA).*sin(Tv))).*((cos(eyRA).^2.*cos(ezRA).^2.*(1-cos(Tv))+cos(Tv)).*sin(exYA).*sin(ezYA)-cos(ezYA).*sin(exYA).*(cos(eyRA).^2.*cos(ezRA).*(1-cos(Tv)).*sin(ezRA)+sin(eyRA).*sin(Tv))+cos(exYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)+cos(eyRA).*sin(ezRA).*sin(Tv)))+(cos(ezYA).*cos(Tv).*sin(exYA)+cos(exYA).*cos(eyRA).*sin(eyRA).*sin(ezRA)-cos(exYA).*cos(eyRA).*cos(Tv).*sin(eyRA).*sin(ezRA)+cos(eyRA).^2.*cos(ezYA).*sin(exYA).*sin(ezRA).^2-cos(eyRA).^2.*cos(ezYA).*cos(Tv).*sin(exYA).*sin(ezRA).^2-cos(eyRA).^2.*cos(ezRA).*sin(exYA).*sin(ezRA).*sin(ezYA)+cos(eyRA).^2.*cos(ezRA).*cos(Tv).*sin(exYA).*sin(ezRA).*sin(ezYA)+cos(exYA).*cos(eyRA).*cos(ezRA).*sin(Tv)+sin(exYA).*sin(eyRA).*sin(ezYA).*sin(Tv)).*sin(Yv))))+h.*(cos(pi./4+eRzR).*cos(eRyY).*((-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)-cos(eyRA).*sin(ezRA).*sin(Tv)).*(cos(Yv)+(1-cos(Yv)).*(cos(exYA).*(cos(Tv)+(1-cos(Tv)).*sin(eyRA).^2)-cos(ezYA).*sin(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)+cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)-cos(eyRA).*sin(ezRA).*sin(Tv))).^2)+(cos(eyRA).^2.*cos(ezRA).*(1-cos(Tv)).*sin(ezRA)-sin(eyRA).*sin(Tv)).*((1-cos(Yv)).*(-cos(ezYA).*sin(exYA).*(cos(Tv)+cos(eyRA).^2.*(1-cos(Tv)).*sin(ezRA).^2)+cos(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)-cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(cos(eyRA).^2.*cos(ezRA).*(1-cos(Tv)).*sin(ezRA)-sin(eyRA).*sin(Tv))).*(cos(exYA).*(cos(Tv)+(1-cos(Tv)).*sin(eyRA).^2)-cos(ezYA).*sin(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)+cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)-cos(eyRA).*sin(ezRA).*sin(Tv)))+(-cos(exYA).*cos(eyRA).*cos(ezRA).*sin(eyRA)+cos(exYA).*cos(eyRA).*cos(ezRA).*cos(Tv).*sin(eyRA)-cos(eyRA).^2.*cos(ezRA).*cos(ezYA).*sin(exYA).*sin(ezRA)+cos(eyRA).^2.*cos(ezRA).*cos(ezYA).*cos(Tv).*sin(exYA).*sin(ezRA)+cos(eyRA).^2.*cos(ezRA).^2.*sin(exYA).*sin(ezYA)+cos(Tv).*sin(exYA).*sin(ezYA)-cos(eyRA).^2.*cos(ezRA).^2.*cos(Tv).*sin(exYA).*sin(ezYA)-cos(ezYA).*sin(exYA).*sin(eyRA).*sin(Tv)+cos(exYA).*cos(eyRA).*sin(ezRA).*sin(Tv)).*sin(Yv))+(cos(eyRA).^2.*cos(ezRA).^2.*(1-cos(Tv))+cos(Tv)).*((1-cos(Yv)).*(cos(exYA).*(cos(Tv)+(1-cos(Tv)).*sin(eyRA).^2)-cos(ezYA).*sin(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)+cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)-cos(eyRA).*sin(ezRA).*sin(Tv))).*((cos(eyRA).^2.*cos(ezRA).^2.*(1-cos(Tv))+cos(Tv)).*sin(exYA).*sin(ezYA)-cos(ezYA).*sin(exYA).*(cos(eyRA).^2.*cos(ezRA).*(1-cos(Tv)).*sin(ezRA)+sin(eyRA).*sin(Tv))+cos(exYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)+cos(eyRA).*sin(ezRA).*sin(Tv)))+(cos(ezYA).*cos(Tv).*sin(exYA)+cos(exYA).*cos(eyRA).*sin(eyRA).*sin(ezRA)-cos(exYA).*cos(eyRA).*cos(Tv).*sin(eyRA).*sin(ezRA)+cos(eyRA).^2.*cos(ezYA).*sin(exYA).*sin(ezRA).^2-cos(eyRA).^2.*cos(ezYA).*cos(Tv).*sin(exYA).*sin(ezRA).^2-cos(eyRA).^2.*cos(ezRA).*sin(exYA).*sin(ezRA).*sin(ezYA)+cos(eyRA).^2.*cos(ezRA).*cos(Tv).*sin(exYA).*sin(ezRA).*sin(ezYA)+cos(exYA).*cos(eyRA).*cos(ezRA).*sin(Tv)+sin(exYA).*sin(eyRA).*sin(ezYA).*sin(Tv)).*sin(Yv)))+(cos(eRyY).*sin(eRxP).*sin(pi./4+eRzR)-cos(eRxP).*sin(eRyY)).*((-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)+cos(eyRA).*cos(ezRA).*sin(Tv)).*(cos(Yv)+(1-cos(Yv)).*(cos(exYA).*(cos(Tv)+(1-cos(Tv)).*sin(eyRA).^2)-cos(ezYA).*sin(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)+cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)-cos(eyRA).*sin(ezRA).*sin(Tv))).^2)+(cos(Tv)+cos(eyRA).^2.*(1-cos(Tv)).*sin(ezRA).^2).*((1-cos(Yv)).*(-cos(ezYA).*sin(exYA).*(cos(Tv)+cos(eyRA).^2.*(1-cos(Tv)).*sin(ezRA).^2)+cos(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)-cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(cos(eyRA).^2.*cos(ezRA).*(1-cos(Tv)).*sin(ezRA)-sin(eyRA).*sin(Tv))).*(cos(exYA).*(cos(Tv)+(1-cos(Tv)).*sin(eyRA).^2)-cos(ezYA).*sin(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)+cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)-cos(eyRA).*sin(ezRA).*sin(Tv)))+(-cos(exYA).*cos(eyRA).*cos(ezRA).*sin(eyRA)+cos(exYA).*cos(eyRA).*cos(ezRA).*cos(Tv).*sin(eyRA)-cos(eyRA).^2.*cos(ezRA).*cos(ezYA).*sin(exYA).*sin(ezRA)+cos(eyRA).^2.*cos(ezRA).*cos(ezYA).*cos(Tv).*sin(exYA).*sin(ezRA)+cos(eyRA).^2.*cos(ezRA).^2.*sin(exYA).*sin(ezYA)+cos(Tv).*sin(exYA).*sin(ezYA)-cos(eyRA).^2.*cos(ezRA).^2.*cos(Tv).*sin(exYA).*sin(ezYA)-cos(ezYA).*sin(exYA).*sin(eyRA).*sin(Tv)+cos(exYA).*cos(eyRA).*sin(ezRA).*sin(Tv)).*sin(Yv))+(cos(eyRA).^2.*cos(ezRA).*(1-cos(Tv)).*sin(ezRA)+sin(eyRA).*sin(Tv)).*((1-cos(Yv)).*(cos(exYA).*(cos(Tv)+(1-cos(Tv)).*sin(eyRA).^2)-cos(ezYA).*sin(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)+cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)-cos(eyRA).*sin(ezRA).*sin(Tv))).*((cos(eyRA).^2.*cos(ezRA).^2.*(1-cos(Tv))+cos(Tv)).*sin(exYA).*sin(ezYA)-cos(ezYA).*sin(exYA).*(cos(eyRA).^2.*cos(ezRA).*(1-cos(Tv)).*sin(ezRA)+sin(eyRA).*sin(Tv))+cos(exYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)+cos(eyRA).*sin(ezRA).*sin(Tv)))+(cos(ezYA).*cos(Tv).*sin(exYA)+cos(exYA).*cos(eyRA).*sin(eyRA).*sin(ezRA)-cos(exYA).*cos(eyRA).*cos(Tv).*sin(eyRA).*sin(ezRA)+cos(eyRA).^2.*cos(ezYA).*sin(exYA).*sin(ezRA).^2-cos(eyRA).^2.*cos(ezYA).*cos(Tv).*sin(exYA).*sin(ezRA).^2-cos(eyRA).^2.*cos(ezRA).*sin(exYA).*sin(ezRA).*sin(ezYA)+cos(eyRA).^2.*cos(ezRA).*cos(Tv).*sin(exYA).*sin(ezRA).*sin(ezYA)+cos(exYA).*cos(eyRA).*cos(ezRA).*sin(Tv)+sin(exYA).*sin(eyRA).*sin(ezYA).*sin(Tv)).*sin(Yv)))+(-cos(eRxP).*cos(eRyY).*sin(pi./4+eRzR)-sin(eRxP).*sin(eRyY)).*((cos(Tv)+(1-cos(Tv)).*sin(eyRA).^2).*(cos(Yv)+(1-cos(Yv)).*(cos(exYA).*(cos(Tv)+(1-cos(Tv)).*sin(eyRA).^2)-cos(ezYA).*sin(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)+cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)-cos(eyRA).*sin(ezRA).*sin(Tv))).^2)+(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)-cos(eyRA).*cos(ezRA).*sin(Tv)).*((1-cos(Yv)).*(-cos(ezYA).*sin(exYA).*(cos(Tv)+cos(eyRA).^2.*(1-cos(Tv)).*sin(ezRA).^2)+cos(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)-cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(cos(eyRA).^2.*cos(ezRA).*(1-cos(Tv)).*sin(ezRA)-sin(eyRA).*sin(Tv))).*(cos(exYA).*(cos(Tv)+(1-cos(Tv)).*sin(eyRA).^2)-cos(ezYA).*sin(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)+cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)-cos(eyRA).*sin(ezRA).*sin(Tv)))+(-cos(exYA).*cos(eyRA).*cos(ezRA).*sin(eyRA)+cos(exYA).*cos(eyRA).*cos(ezRA).*cos(Tv).*sin(eyRA)-cos(eyRA).^2.*cos(ezRA).*cos(ezYA).*sin(exYA).*sin(ezRA)+cos(eyRA).^2.*cos(ezRA).*cos(ezYA).*cos(Tv).*sin(exYA).*sin(ezRA)+cos(eyRA).^2.*cos(ezRA).^2.*sin(exYA).*sin(ezYA)+cos(Tv).*sin(exYA).*sin(ezYA)-cos(eyRA).^2.*cos(ezRA).^2.*cos(Tv).*sin(exYA).*sin(ezYA)-cos(ezYA).*sin(exYA).*sin(eyRA).*sin(Tv)+cos(exYA).*cos(eyRA).*sin(ezRA).*sin(Tv)).*sin(Yv))+(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)+cos(eyRA).*sin(ezRA).*sin(Tv)).*((1-cos(Yv)).*(cos(exYA).*(cos(Tv)+(1-cos(Tv)).*sin(eyRA).^2)-cos(ezYA).*sin(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)+cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)-cos(eyRA).*sin(ezRA).*sin(Tv))).*((cos(eyRA).^2.*cos(ezRA).^2.*(1-cos(Tv))+cos(Tv)).*sin(exYA).*sin(ezYA)-cos(ezYA).*sin(exYA).*(cos(eyRA).^2.*cos(ezRA).*(1-cos(Tv)).*sin(ezRA)+sin(eyRA).*sin(Tv))+cos(exYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)+cos(eyRA).*sin(ezRA).*sin(Tv)))+(cos(ezYA).*cos(Tv).*sin(exYA)+cos(exYA).*cos(eyRA).*sin(eyRA).*sin(ezRA)-cos(exYA).*cos(eyRA).*cos(Tv).*sin(eyRA).*sin(ezRA)+cos(eyRA).^2.*cos(ezYA).*sin(exYA).*sin(ezRA).^2-cos(eyRA).^2.*cos(ezYA).*cos(Tv).*sin(exYA).*sin(ezRA).^2-cos(eyRA).^2.*cos(ezRA).*sin(exYA).*sin(ezRA).*sin(ezYA)+cos(eyRA).^2.*cos(ezRA).*cos(Tv).*sin(exYA).*sin(ezRA).*sin(ezYA)+cos(exYA).*cos(eyRA).*cos(ezRA).*sin(Tv)+sin(exYA).*sin(eyRA).*sin(ezYA).*sin(Tv)).*sin(Yv))))+l.*(cos(pi./4+eRzR).*sin(eRyY).*((-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)-cos(eyRA).*sin(ezRA).*sin(Tv)).*(cos(Yv)+(1-cos(Yv)).*(cos(exYA).*(cos(Tv)+(1-cos(Tv)).*sin(eyRA).^2)-cos(ezYA).*sin(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)+cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)-cos(eyRA).*sin(ezRA).*sin(Tv))).^2)+(cos(eyRA).^2.*cos(ezRA).*(1-cos(Tv)).*sin(ezRA)-sin(eyRA).*sin(Tv)).*((1-cos(Yv)).*(-cos(ezYA).*sin(exYA).*(cos(Tv)+cos(eyRA).^2.*(1-cos(Tv)).*sin(ezRA).^2)+cos(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)-cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(cos(eyRA).^2.*cos(ezRA).*(1-cos(Tv)).*sin(ezRA)-sin(eyRA).*sin(Tv))).*(cos(exYA).*(cos(Tv)+(1-cos(Tv)).*sin(eyRA).^2)-cos(ezYA).*sin(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)+cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)-cos(eyRA).*sin(ezRA).*sin(Tv)))+(-cos(exYA).*cos(eyRA).*cos(ezRA).*sin(eyRA)+cos(exYA).*cos(eyRA).*cos(ezRA).*cos(Tv).*sin(eyRA)-cos(eyRA).^2.*cos(ezRA).*cos(ezYA).*sin(exYA).*sin(ezRA)+cos(eyRA).^2.*cos(ezRA).*cos(ezYA).*cos(Tv).*sin(exYA).*sin(ezRA)+cos(eyRA).^2.*cos(ezRA).^2.*sin(exYA).*sin(ezYA)+cos(Tv).*sin(exYA).*sin(ezYA)-cos(eyRA).^2.*cos(ezRA).^2.*cos(Tv).*sin(exYA).*sin(ezYA)-cos(ezYA).*sin(exYA).*sin(eyRA).*sin(Tv)+cos(exYA).*cos(eyRA).*sin(ezRA).*sin(Tv)).*sin(Yv))+(cos(eyRA).^2.*cos(ezRA).^2.*(1-cos(Tv))+cos(Tv)).*((1-cos(Yv)).*(cos(exYA).*(cos(Tv)+(1-cos(Tv)).*sin(eyRA).^2)-cos(ezYA).*sin(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)+cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)-cos(eyRA).*sin(ezRA).*sin(Tv))).*((cos(eyRA).^2.*cos(ezRA).^2.*(1-cos(Tv))+cos(Tv)).*sin(exYA).*sin(ezYA)-cos(ezYA).*sin(exYA).*(cos(eyRA).^2.*cos(ezRA).*(1-cos(Tv)).*sin(ezRA)+sin(eyRA).*sin(Tv))+cos(exYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)+cos(eyRA).*sin(ezRA).*sin(Tv)))+(cos(ezYA).*cos(Tv).*sin(exYA)+cos(exYA).*cos(eyRA).*sin(eyRA).*sin(ezRA)-cos(exYA).*cos(eyRA).*cos(Tv).*sin(eyRA).*sin(ezRA)+cos(eyRA).^2.*cos(ezYA).*sin(exYA).*sin(ezRA).^2-cos(eyRA).^2.*cos(ezYA).*cos(Tv).*sin(exYA).*sin(ezRA).^2-cos(eyRA).^2.*cos(ezRA).*sin(exYA).*sin(ezRA).*sin(ezYA)+cos(eyRA).^2.*cos(ezRA).*cos(Tv).*sin(exYA).*sin(ezRA).*sin(ezYA)+cos(exYA).*cos(eyRA).*cos(ezRA).*sin(Tv)+sin(exYA).*sin(eyRA).*sin(ezYA).*sin(Tv)).*sin(Yv)))+(cos(eRxP).*cos(eRyY)+sin(eRxP).*sin(pi./4+eRzR).*sin(eRyY)).*((-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)+cos(eyRA).*cos(ezRA).*sin(Tv)).*(cos(Yv)+(1-cos(Yv)).*(cos(exYA).*(cos(Tv)+(1-cos(Tv)).*sin(eyRA).^2)-cos(ezYA).*sin(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)+cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)-cos(eyRA).*sin(ezRA).*sin(Tv))).^2)+(cos(Tv)+cos(eyRA).^2.*(1-cos(Tv)).*sin(ezRA).^2).*((1-cos(Yv)).*(-cos(ezYA).*sin(exYA).*(cos(Tv)+cos(eyRA).^2.*(1-cos(Tv)).*sin(ezRA).^2)+cos(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)-cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(cos(eyRA).^2.*cos(ezRA).*(1-cos(Tv)).*sin(ezRA)-sin(eyRA).*sin(Tv))).*(cos(exYA).*(cos(Tv)+(1-cos(Tv)).*sin(eyRA).^2)-cos(ezYA).*sin(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)+cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)-cos(eyRA).*sin(ezRA).*sin(Tv)))+(-cos(exYA).*cos(eyRA).*cos(ezRA).*sin(eyRA)+cos(exYA).*cos(eyRA).*cos(ezRA).*cos(Tv).*sin(eyRA)-cos(eyRA).^2.*cos(ezRA).*cos(ezYA).*sin(exYA).*sin(ezRA)+cos(eyRA).^2.*cos(ezRA).*cos(ezYA).*cos(Tv).*sin(exYA).*sin(ezRA)+cos(eyRA).^2.*cos(ezRA).^2.*sin(exYA).*sin(ezYA)+cos(Tv).*sin(exYA).*sin(ezYA)-cos(eyRA).^2.*cos(ezRA).^2.*cos(Tv).*sin(exYA).*sin(ezYA)-cos(ezYA).*sin(exYA).*sin(eyRA).*sin(Tv)+cos(exYA).*cos(eyRA).*sin(ezRA).*sin(Tv)).*sin(Yv))+(cos(eyRA).^2.*cos(ezRA).*(1-cos(Tv)).*sin(ezRA)+sin(eyRA).*sin(Tv)).*((1-cos(Yv)).*(cos(exYA).*(cos(Tv)+(1-cos(Tv)).*sin(eyRA).^2)-cos(ezYA).*sin(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)+cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)-cos(eyRA).*sin(ezRA).*sin(Tv))).*((cos(eyRA).^2.*cos(ezRA).^2.*(1-cos(Tv))+cos(Tv)).*sin(exYA).*sin(ezYA)-cos(ezYA).*sin(exYA).*(cos(eyRA).^2.*cos(ezRA).*(1-cos(Tv)).*sin(ezRA)+sin(eyRA).*sin(Tv))+cos(exYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)+cos(eyRA).*sin(ezRA).*sin(Tv)))+(cos(ezYA).*cos(Tv).*sin(exYA)+cos(exYA).*cos(eyRA).*sin(eyRA).*sin(ezRA)-cos(exYA).*cos(eyRA).*cos(Tv).*sin(eyRA).*sin(ezRA)+cos(eyRA).^2.*cos(ezYA).*sin(exYA).*sin(ezRA).^2-cos(eyRA).^2.*cos(ezYA).*cos(Tv).*sin(exYA).*sin(ezRA).^2-cos(eyRA).^2.*cos(ezRA).*sin(exYA).*sin(ezRA).*sin(ezYA)+cos(eyRA).^2.*cos(ezRA).*cos(Tv).*sin(exYA).*sin(ezRA).*sin(ezYA)+cos(exYA).*cos(eyRA).*cos(ezRA).*sin(Tv)+sin(exYA).*sin(eyRA).*sin(ezYA).*sin(Tv)).*sin(Yv)))+(cos(eRyY).*sin(eRxP)-cos(eRxP).*sin(pi./4+eRzR).*sin(eRyY)).*((cos(Tv)+(1-cos(Tv)).*sin(eyRA).^2).*(cos(Yv)+(1-cos(Yv)).*(cos(exYA).*(cos(Tv)+(1-cos(Tv)).*sin(eyRA).^2)-cos(ezYA).*sin(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)+cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)-cos(eyRA).*sin(ezRA).*sin(Tv))).^2)+(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)-cos(eyRA).*cos(ezRA).*sin(Tv)).*((1-cos(Yv)).*(-cos(ezYA).*sin(exYA).*(cos(Tv)+cos(eyRA).^2.*(1-cos(Tv)).*sin(ezRA).^2)+cos(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)-cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(cos(eyRA).^2.*cos(ezRA).*(1-cos(Tv)).*sin(ezRA)-sin(eyRA).*sin(Tv))).*(cos(exYA).*(cos(Tv)+(1-cos(Tv)).*sin(eyRA).^2)-cos(ezYA).*sin(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)+cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)-cos(eyRA).*sin(ezRA).*sin(Tv)))+(-cos(exYA).*cos(eyRA).*cos(ezRA).*sin(eyRA)+cos(exYA).*cos(eyRA).*cos(ezRA).*cos(Tv).*sin(eyRA)-cos(eyRA).^2.*cos(ezRA).*cos(ezYA).*sin(exYA).*sin(ezRA)+cos(eyRA).^2.*cos(ezRA).*cos(ezYA).*cos(Tv).*sin(exYA).*sin(ezRA)+cos(eyRA).^2.*cos(ezRA).^2.*sin(exYA).*sin(ezYA)+cos(Tv).*sin(exYA).*sin(ezYA)-cos(eyRA).^2.*cos(ezRA).^2.*cos(Tv).*sin(exYA).*sin(ezYA)-cos(ezYA).*sin(exYA).*sin(eyRA).*sin(Tv)+cos(exYA).*cos(eyRA).*sin(ezRA).*sin(Tv)).*sin(Yv))+(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)+cos(eyRA).*sin(ezRA).*sin(Tv)).*((1-cos(Yv)).*(cos(exYA).*(cos(Tv)+(1-cos(Tv)).*sin(eyRA).^2)-cos(ezYA).*sin(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)+cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)-cos(eyRA).*sin(ezRA).*sin(Tv))).*((cos(eyRA).^2.*cos(ezRA).^2.*(1-cos(Tv))+cos(Tv)).*sin(exYA).*sin(ezYA)-cos(ezYA).*sin(exYA).*(cos(eyRA).^2.*cos(ezRA).*(1-cos(Tv)).*sin(ezRA)+sin(eyRA).*sin(Tv))+cos(exYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)+cos(eyRA).*sin(ezRA).*sin(Tv)))+(cos(ezYA).*cos(Tv).*sin(exYA)+cos(exYA).*cos(eyRA).*sin(eyRA).*sin(ezRA)-cos(exYA).*cos(eyRA).*cos(Tv).*sin(eyRA).*sin(ezRA)+cos(eyRA).^2.*cos(ezYA).*sin(exYA).*sin(ezRA).^2-cos(eyRA).^2.*cos(ezYA).*cos(Tv).*sin(exYA).*sin(ezRA).^2-cos(eyRA).^2.*cos(ezRA).*sin(exYA).*sin(ezRA).*sin(ezYA)+cos(eyRA).^2.*cos(ezRA).*cos(Tv).*sin(exYA).*sin(ezRA).*sin(ezYA)+cos(exYA).*cos(eyRA).*cos(ezRA).*sin(Tv)+sin(exYA).*sin(eyRA).*sin(ezYA).*sin(Tv)).*sin(Yv))))));
    
    lambda_m=abs(2*Lattice*sin(pi/2-angolo)/sqrt(h^2+k^2+l^2)/norder);
    photon_energy_ev = hplanck*cluce./lambda_m; 
    angolo=angolo*180/pi;
    lambda_m=abs(lambda_m);
end

if(numel(Reflection)>3)
    [SRa,SRb]=size(Reflection);
    if(SRb~=3)
       Reflection=transpose(Reflection); 
    end
    if(isrow(T_S))
        T_S=transpose(T_S);
    end
    if(isrow(Y_S))
        Y_S=transpose(Y_S);
    end
    h=Reflection(:,1); k=Reflection(:,2); l=Reflection(:,3);
    Yv=((Y_S+YMis)/180*pi);
    Tv=((T_S+TMis)/180*pi);
    angolo=acos((1./sqrt(h.^2+k.^2+l.^2)).*(k.*(-sin(pi./4+eRzR).*((-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)-cos(eyRA).*sin(ezRA).*sin(Tv)).*(cos(Yv)+(1-cos(Yv)).*(cos(exYA).*(cos(Tv)+(1-cos(Tv)).*sin(eyRA).^2)-cos(ezYA).*sin(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)+cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)-cos(eyRA).*sin(ezRA).*sin(Tv))).^2)+(cos(eyRA).^2.*cos(ezRA).*(1-cos(Tv)).*sin(ezRA)-sin(eyRA).*sin(Tv)).*((1-cos(Yv)).*(-cos(ezYA).*sin(exYA).*(cos(Tv)+cos(eyRA).^2.*(1-cos(Tv)).*sin(ezRA).^2)+cos(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)-cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(cos(eyRA).^2.*cos(ezRA).*(1-cos(Tv)).*sin(ezRA)-sin(eyRA).*sin(Tv))).*(cos(exYA).*(cos(Tv)+(1-cos(Tv)).*sin(eyRA).^2)-cos(ezYA).*sin(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)+cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)-cos(eyRA).*sin(ezRA).*sin(Tv)))+(-cos(exYA).*cos(eyRA).*cos(ezRA).*sin(eyRA)+cos(exYA).*cos(eyRA).*cos(ezRA).*cos(Tv).*sin(eyRA)-cos(eyRA).^2.*cos(ezRA).*cos(ezYA).*sin(exYA).*sin(ezRA)+cos(eyRA).^2.*cos(ezRA).*cos(ezYA).*cos(Tv).*sin(exYA).*sin(ezRA)+cos(eyRA).^2.*cos(ezRA).^2.*sin(exYA).*sin(ezYA)+cos(Tv).*sin(exYA).*sin(ezYA)-cos(eyRA).^2.*cos(ezRA).^2.*cos(Tv).*sin(exYA).*sin(ezYA)-cos(ezYA).*sin(exYA).*sin(eyRA).*sin(Tv)+cos(exYA).*cos(eyRA).*sin(ezRA).*sin(Tv)).*sin(Yv))+(cos(eyRA).^2.*cos(ezRA).^2.*(1-cos(Tv))+cos(Tv)).*((1-cos(Yv)).*(cos(exYA).*(cos(Tv)+(1-cos(Tv)).*sin(eyRA).^2)-cos(ezYA).*sin(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)+cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)-cos(eyRA).*sin(ezRA).*sin(Tv))).*((cos(eyRA).^2.*cos(ezRA).^2.*(1-cos(Tv))+cos(Tv)).*sin(exYA).*sin(ezYA)-cos(ezYA).*sin(exYA).*(cos(eyRA).^2.*cos(ezRA).*(1-cos(Tv)).*sin(ezRA)+sin(eyRA).*sin(Tv))+cos(exYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)+cos(eyRA).*sin(ezRA).*sin(Tv)))+(cos(ezYA).*cos(Tv).*sin(exYA)+cos(exYA).*cos(eyRA).*sin(eyRA).*sin(ezRA)-cos(exYA).*cos(eyRA).*cos(Tv).*sin(eyRA).*sin(ezRA)+cos(eyRA).^2.*cos(ezYA).*sin(exYA).*sin(ezRA).^2-cos(eyRA).^2.*cos(ezYA).*cos(Tv).*sin(exYA).*sin(ezRA).^2-cos(eyRA).^2.*cos(ezRA).*sin(exYA).*sin(ezRA).*sin(ezYA)+cos(eyRA).^2.*cos(ezRA).*cos(Tv).*sin(exYA).*sin(ezRA).*sin(ezYA)+cos(exYA).*cos(eyRA).*cos(ezRA).*sin(Tv)+sin(exYA).*sin(eyRA).*sin(ezYA).*sin(Tv)).*sin(Yv)))+cos(pi./4+eRzR).*sin(eRxP).*((-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)+cos(eyRA).*cos(ezRA).*sin(Tv)).*(cos(Yv)+(1-cos(Yv)).*(cos(exYA).*(cos(Tv)+(1-cos(Tv)).*sin(eyRA).^2)-cos(ezYA).*sin(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)+cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)-cos(eyRA).*sin(ezRA).*sin(Tv))).^2)+(cos(Tv)+cos(eyRA).^2.*(1-cos(Tv)).*sin(ezRA).^2).*((1-cos(Yv)).*(-cos(ezYA).*sin(exYA).*(cos(Tv)+cos(eyRA).^2.*(1-cos(Tv)).*sin(ezRA).^2)+cos(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)-cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(cos(eyRA).^2.*cos(ezRA).*(1-cos(Tv)).*sin(ezRA)-sin(eyRA).*sin(Tv))).*(cos(exYA).*(cos(Tv)+(1-cos(Tv)).*sin(eyRA).^2)-cos(ezYA).*sin(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)+cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)-cos(eyRA).*sin(ezRA).*sin(Tv)))+(-cos(exYA).*cos(eyRA).*cos(ezRA).*sin(eyRA)+cos(exYA).*cos(eyRA).*cos(ezRA).*cos(Tv).*sin(eyRA)-cos(eyRA).^2.*cos(ezRA).*cos(ezYA).*sin(exYA).*sin(ezRA)+cos(eyRA).^2.*cos(ezRA).*cos(ezYA).*cos(Tv).*sin(exYA).*sin(ezRA)+cos(eyRA).^2.*cos(ezRA).^2.*sin(exYA).*sin(ezYA)+cos(Tv).*sin(exYA).*sin(ezYA)-cos(eyRA).^2.*cos(ezRA).^2.*cos(Tv).*sin(exYA).*sin(ezYA)-cos(ezYA).*sin(exYA).*sin(eyRA).*sin(Tv)+cos(exYA).*cos(eyRA).*sin(ezRA).*sin(Tv)).*sin(Yv))+(cos(eyRA).^2.*cos(ezRA).*(1-cos(Tv)).*sin(ezRA)+sin(eyRA).*sin(Tv)).*((1-cos(Yv)).*(cos(exYA).*(cos(Tv)+(1-cos(Tv)).*sin(eyRA).^2)-cos(ezYA).*sin(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)+cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)-cos(eyRA).*sin(ezRA).*sin(Tv))).*((cos(eyRA).^2.*cos(ezRA).^2.*(1-cos(Tv))+cos(Tv)).*sin(exYA).*sin(ezYA)-cos(ezYA).*sin(exYA).*(cos(eyRA).^2.*cos(ezRA).*(1-cos(Tv)).*sin(ezRA)+sin(eyRA).*sin(Tv))+cos(exYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)+cos(eyRA).*sin(ezRA).*sin(Tv)))+(cos(ezYA).*cos(Tv).*sin(exYA)+cos(exYA).*cos(eyRA).*sin(eyRA).*sin(ezRA)-cos(exYA).*cos(eyRA).*cos(Tv).*sin(eyRA).*sin(ezRA)+cos(eyRA).^2.*cos(ezYA).*sin(exYA).*sin(ezRA).^2-cos(eyRA).^2.*cos(ezYA).*cos(Tv).*sin(exYA).*sin(ezRA).^2-cos(eyRA).^2.*cos(ezRA).*sin(exYA).*sin(ezRA).*sin(ezYA)+cos(eyRA).^2.*cos(ezRA).*cos(Tv).*sin(exYA).*sin(ezRA).*sin(ezYA)+cos(exYA).*cos(eyRA).*cos(ezRA).*sin(Tv)+sin(exYA).*sin(eyRA).*sin(ezYA).*sin(Tv)).*sin(Yv)))-cos(eRxP).*cos(pi./4+eRzR).*((cos(Tv)+(1-cos(Tv)).*sin(eyRA).^2).*(cos(Yv)+(1-cos(Yv)).*(cos(exYA).*(cos(Tv)+(1-cos(Tv)).*sin(eyRA).^2)-cos(ezYA).*sin(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)+cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)-cos(eyRA).*sin(ezRA).*sin(Tv))).^2)+(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)-cos(eyRA).*cos(ezRA).*sin(Tv)).*((1-cos(Yv)).*(-cos(ezYA).*sin(exYA).*(cos(Tv)+cos(eyRA).^2.*(1-cos(Tv)).*sin(ezRA).^2)+cos(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)-cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(cos(eyRA).^2.*cos(ezRA).*(1-cos(Tv)).*sin(ezRA)-sin(eyRA).*sin(Tv))).*(cos(exYA).*(cos(Tv)+(1-cos(Tv)).*sin(eyRA).^2)-cos(ezYA).*sin(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)+cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)-cos(eyRA).*sin(ezRA).*sin(Tv)))+(-cos(exYA).*cos(eyRA).*cos(ezRA).*sin(eyRA)+cos(exYA).*cos(eyRA).*cos(ezRA).*cos(Tv).*sin(eyRA)-cos(eyRA).^2.*cos(ezRA).*cos(ezYA).*sin(exYA).*sin(ezRA)+cos(eyRA).^2.*cos(ezRA).*cos(ezYA).*cos(Tv).*sin(exYA).*sin(ezRA)+cos(eyRA).^2.*cos(ezRA).^2.*sin(exYA).*sin(ezYA)+cos(Tv).*sin(exYA).*sin(ezYA)-cos(eyRA).^2.*cos(ezRA).^2.*cos(Tv).*sin(exYA).*sin(ezYA)-cos(ezYA).*sin(exYA).*sin(eyRA).*sin(Tv)+cos(exYA).*cos(eyRA).*sin(ezRA).*sin(Tv)).*sin(Yv))+(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)+cos(eyRA).*sin(ezRA).*sin(Tv)).*((1-cos(Yv)).*(cos(exYA).*(cos(Tv)+(1-cos(Tv)).*sin(eyRA).^2)-cos(ezYA).*sin(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)+cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)-cos(eyRA).*sin(ezRA).*sin(Tv))).*((cos(eyRA).^2.*cos(ezRA).^2.*(1-cos(Tv))+cos(Tv)).*sin(exYA).*sin(ezYA)-cos(ezYA).*sin(exYA).*(cos(eyRA).^2.*cos(ezRA).*(1-cos(Tv)).*sin(ezRA)+sin(eyRA).*sin(Tv))+cos(exYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)+cos(eyRA).*sin(ezRA).*sin(Tv)))+(cos(ezYA).*cos(Tv).*sin(exYA)+cos(exYA).*cos(eyRA).*sin(eyRA).*sin(ezRA)-cos(exYA).*cos(eyRA).*cos(Tv).*sin(eyRA).*sin(ezRA)+cos(eyRA).^2.*cos(ezYA).*sin(exYA).*sin(ezRA).^2-cos(eyRA).^2.*cos(ezYA).*cos(Tv).*sin(exYA).*sin(ezRA).^2-cos(eyRA).^2.*cos(ezRA).*sin(exYA).*sin(ezRA).*sin(ezYA)+cos(eyRA).^2.*cos(ezRA).*cos(Tv).*sin(exYA).*sin(ezRA).*sin(ezYA)+cos(exYA).*cos(eyRA).*cos(ezRA).*sin(Tv)+sin(exYA).*sin(eyRA).*sin(ezYA).*sin(Tv)).*sin(Yv))))+h.*(cos(pi./4+eRzR).*cos(eRyY).*((-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)-cos(eyRA).*sin(ezRA).*sin(Tv)).*(cos(Yv)+(1-cos(Yv)).*(cos(exYA).*(cos(Tv)+(1-cos(Tv)).*sin(eyRA).^2)-cos(ezYA).*sin(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)+cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)-cos(eyRA).*sin(ezRA).*sin(Tv))).^2)+(cos(eyRA).^2.*cos(ezRA).*(1-cos(Tv)).*sin(ezRA)-sin(eyRA).*sin(Tv)).*((1-cos(Yv)).*(-cos(ezYA).*sin(exYA).*(cos(Tv)+cos(eyRA).^2.*(1-cos(Tv)).*sin(ezRA).^2)+cos(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)-cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(cos(eyRA).^2.*cos(ezRA).*(1-cos(Tv)).*sin(ezRA)-sin(eyRA).*sin(Tv))).*(cos(exYA).*(cos(Tv)+(1-cos(Tv)).*sin(eyRA).^2)-cos(ezYA).*sin(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)+cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)-cos(eyRA).*sin(ezRA).*sin(Tv)))+(-cos(exYA).*cos(eyRA).*cos(ezRA).*sin(eyRA)+cos(exYA).*cos(eyRA).*cos(ezRA).*cos(Tv).*sin(eyRA)-cos(eyRA).^2.*cos(ezRA).*cos(ezYA).*sin(exYA).*sin(ezRA)+cos(eyRA).^2.*cos(ezRA).*cos(ezYA).*cos(Tv).*sin(exYA).*sin(ezRA)+cos(eyRA).^2.*cos(ezRA).^2.*sin(exYA).*sin(ezYA)+cos(Tv).*sin(exYA).*sin(ezYA)-cos(eyRA).^2.*cos(ezRA).^2.*cos(Tv).*sin(exYA).*sin(ezYA)-cos(ezYA).*sin(exYA).*sin(eyRA).*sin(Tv)+cos(exYA).*cos(eyRA).*sin(ezRA).*sin(Tv)).*sin(Yv))+(cos(eyRA).^2.*cos(ezRA).^2.*(1-cos(Tv))+cos(Tv)).*((1-cos(Yv)).*(cos(exYA).*(cos(Tv)+(1-cos(Tv)).*sin(eyRA).^2)-cos(ezYA).*sin(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)+cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)-cos(eyRA).*sin(ezRA).*sin(Tv))).*((cos(eyRA).^2.*cos(ezRA).^2.*(1-cos(Tv))+cos(Tv)).*sin(exYA).*sin(ezYA)-cos(ezYA).*sin(exYA).*(cos(eyRA).^2.*cos(ezRA).*(1-cos(Tv)).*sin(ezRA)+sin(eyRA).*sin(Tv))+cos(exYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)+cos(eyRA).*sin(ezRA).*sin(Tv)))+(cos(ezYA).*cos(Tv).*sin(exYA)+cos(exYA).*cos(eyRA).*sin(eyRA).*sin(ezRA)-cos(exYA).*cos(eyRA).*cos(Tv).*sin(eyRA).*sin(ezRA)+cos(eyRA).^2.*cos(ezYA).*sin(exYA).*sin(ezRA).^2-cos(eyRA).^2.*cos(ezYA).*cos(Tv).*sin(exYA).*sin(ezRA).^2-cos(eyRA).^2.*cos(ezRA).*sin(exYA).*sin(ezRA).*sin(ezYA)+cos(eyRA).^2.*cos(ezRA).*cos(Tv).*sin(exYA).*sin(ezRA).*sin(ezYA)+cos(exYA).*cos(eyRA).*cos(ezRA).*sin(Tv)+sin(exYA).*sin(eyRA).*sin(ezYA).*sin(Tv)).*sin(Yv)))+(cos(eRyY).*sin(eRxP).*sin(pi./4+eRzR)-cos(eRxP).*sin(eRyY)).*((-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)+cos(eyRA).*cos(ezRA).*sin(Tv)).*(cos(Yv)+(1-cos(Yv)).*(cos(exYA).*(cos(Tv)+(1-cos(Tv)).*sin(eyRA).^2)-cos(ezYA).*sin(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)+cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)-cos(eyRA).*sin(ezRA).*sin(Tv))).^2)+(cos(Tv)+cos(eyRA).^2.*(1-cos(Tv)).*sin(ezRA).^2).*((1-cos(Yv)).*(-cos(ezYA).*sin(exYA).*(cos(Tv)+cos(eyRA).^2.*(1-cos(Tv)).*sin(ezRA).^2)+cos(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)-cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(cos(eyRA).^2.*cos(ezRA).*(1-cos(Tv)).*sin(ezRA)-sin(eyRA).*sin(Tv))).*(cos(exYA).*(cos(Tv)+(1-cos(Tv)).*sin(eyRA).^2)-cos(ezYA).*sin(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)+cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)-cos(eyRA).*sin(ezRA).*sin(Tv)))+(-cos(exYA).*cos(eyRA).*cos(ezRA).*sin(eyRA)+cos(exYA).*cos(eyRA).*cos(ezRA).*cos(Tv).*sin(eyRA)-cos(eyRA).^2.*cos(ezRA).*cos(ezYA).*sin(exYA).*sin(ezRA)+cos(eyRA).^2.*cos(ezRA).*cos(ezYA).*cos(Tv).*sin(exYA).*sin(ezRA)+cos(eyRA).^2.*cos(ezRA).^2.*sin(exYA).*sin(ezYA)+cos(Tv).*sin(exYA).*sin(ezYA)-cos(eyRA).^2.*cos(ezRA).^2.*cos(Tv).*sin(exYA).*sin(ezYA)-cos(ezYA).*sin(exYA).*sin(eyRA).*sin(Tv)+cos(exYA).*cos(eyRA).*sin(ezRA).*sin(Tv)).*sin(Yv))+(cos(eyRA).^2.*cos(ezRA).*(1-cos(Tv)).*sin(ezRA)+sin(eyRA).*sin(Tv)).*((1-cos(Yv)).*(cos(exYA).*(cos(Tv)+(1-cos(Tv)).*sin(eyRA).^2)-cos(ezYA).*sin(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)+cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)-cos(eyRA).*sin(ezRA).*sin(Tv))).*((cos(eyRA).^2.*cos(ezRA).^2.*(1-cos(Tv))+cos(Tv)).*sin(exYA).*sin(ezYA)-cos(ezYA).*sin(exYA).*(cos(eyRA).^2.*cos(ezRA).*(1-cos(Tv)).*sin(ezRA)+sin(eyRA).*sin(Tv))+cos(exYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)+cos(eyRA).*sin(ezRA).*sin(Tv)))+(cos(ezYA).*cos(Tv).*sin(exYA)+cos(exYA).*cos(eyRA).*sin(eyRA).*sin(ezRA)-cos(exYA).*cos(eyRA).*cos(Tv).*sin(eyRA).*sin(ezRA)+cos(eyRA).^2.*cos(ezYA).*sin(exYA).*sin(ezRA).^2-cos(eyRA).^2.*cos(ezYA).*cos(Tv).*sin(exYA).*sin(ezRA).^2-cos(eyRA).^2.*cos(ezRA).*sin(exYA).*sin(ezRA).*sin(ezYA)+cos(eyRA).^2.*cos(ezRA).*cos(Tv).*sin(exYA).*sin(ezRA).*sin(ezYA)+cos(exYA).*cos(eyRA).*cos(ezRA).*sin(Tv)+sin(exYA).*sin(eyRA).*sin(ezYA).*sin(Tv)).*sin(Yv)))+(-cos(eRxP).*cos(eRyY).*sin(pi./4+eRzR)-sin(eRxP).*sin(eRyY)).*((cos(Tv)+(1-cos(Tv)).*sin(eyRA).^2).*(cos(Yv)+(1-cos(Yv)).*(cos(exYA).*(cos(Tv)+(1-cos(Tv)).*sin(eyRA).^2)-cos(ezYA).*sin(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)+cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)-cos(eyRA).*sin(ezRA).*sin(Tv))).^2)+(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)-cos(eyRA).*cos(ezRA).*sin(Tv)).*((1-cos(Yv)).*(-cos(ezYA).*sin(exYA).*(cos(Tv)+cos(eyRA).^2.*(1-cos(Tv)).*sin(ezRA).^2)+cos(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)-cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(cos(eyRA).^2.*cos(ezRA).*(1-cos(Tv)).*sin(ezRA)-sin(eyRA).*sin(Tv))).*(cos(exYA).*(cos(Tv)+(1-cos(Tv)).*sin(eyRA).^2)-cos(ezYA).*sin(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)+cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)-cos(eyRA).*sin(ezRA).*sin(Tv)))+(-cos(exYA).*cos(eyRA).*cos(ezRA).*sin(eyRA)+cos(exYA).*cos(eyRA).*cos(ezRA).*cos(Tv).*sin(eyRA)-cos(eyRA).^2.*cos(ezRA).*cos(ezYA).*sin(exYA).*sin(ezRA)+cos(eyRA).^2.*cos(ezRA).*cos(ezYA).*cos(Tv).*sin(exYA).*sin(ezRA)+cos(eyRA).^2.*cos(ezRA).^2.*sin(exYA).*sin(ezYA)+cos(Tv).*sin(exYA).*sin(ezYA)-cos(eyRA).^2.*cos(ezRA).^2.*cos(Tv).*sin(exYA).*sin(ezYA)-cos(ezYA).*sin(exYA).*sin(eyRA).*sin(Tv)+cos(exYA).*cos(eyRA).*sin(ezRA).*sin(Tv)).*sin(Yv))+(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)+cos(eyRA).*sin(ezRA).*sin(Tv)).*((1-cos(Yv)).*(cos(exYA).*(cos(Tv)+(1-cos(Tv)).*sin(eyRA).^2)-cos(ezYA).*sin(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)+cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)-cos(eyRA).*sin(ezRA).*sin(Tv))).*((cos(eyRA).^2.*cos(ezRA).^2.*(1-cos(Tv))+cos(Tv)).*sin(exYA).*sin(ezYA)-cos(ezYA).*sin(exYA).*(cos(eyRA).^2.*cos(ezRA).*(1-cos(Tv)).*sin(ezRA)+sin(eyRA).*sin(Tv))+cos(exYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)+cos(eyRA).*sin(ezRA).*sin(Tv)))+(cos(ezYA).*cos(Tv).*sin(exYA)+cos(exYA).*cos(eyRA).*sin(eyRA).*sin(ezRA)-cos(exYA).*cos(eyRA).*cos(Tv).*sin(eyRA).*sin(ezRA)+cos(eyRA).^2.*cos(ezYA).*sin(exYA).*sin(ezRA).^2-cos(eyRA).^2.*cos(ezYA).*cos(Tv).*sin(exYA).*sin(ezRA).^2-cos(eyRA).^2.*cos(ezRA).*sin(exYA).*sin(ezRA).*sin(ezYA)+cos(eyRA).^2.*cos(ezRA).*cos(Tv).*sin(exYA).*sin(ezRA).*sin(ezYA)+cos(exYA).*cos(eyRA).*cos(ezRA).*sin(Tv)+sin(exYA).*sin(eyRA).*sin(ezYA).*sin(Tv)).*sin(Yv))))+l.*(cos(pi./4+eRzR).*sin(eRyY).*((-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)-cos(eyRA).*sin(ezRA).*sin(Tv)).*(cos(Yv)+(1-cos(Yv)).*(cos(exYA).*(cos(Tv)+(1-cos(Tv)).*sin(eyRA).^2)-cos(ezYA).*sin(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)+cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)-cos(eyRA).*sin(ezRA).*sin(Tv))).^2)+(cos(eyRA).^2.*cos(ezRA).*(1-cos(Tv)).*sin(ezRA)-sin(eyRA).*sin(Tv)).*((1-cos(Yv)).*(-cos(ezYA).*sin(exYA).*(cos(Tv)+cos(eyRA).^2.*(1-cos(Tv)).*sin(ezRA).^2)+cos(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)-cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(cos(eyRA).^2.*cos(ezRA).*(1-cos(Tv)).*sin(ezRA)-sin(eyRA).*sin(Tv))).*(cos(exYA).*(cos(Tv)+(1-cos(Tv)).*sin(eyRA).^2)-cos(ezYA).*sin(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)+cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)-cos(eyRA).*sin(ezRA).*sin(Tv)))+(-cos(exYA).*cos(eyRA).*cos(ezRA).*sin(eyRA)+cos(exYA).*cos(eyRA).*cos(ezRA).*cos(Tv).*sin(eyRA)-cos(eyRA).^2.*cos(ezRA).*cos(ezYA).*sin(exYA).*sin(ezRA)+cos(eyRA).^2.*cos(ezRA).*cos(ezYA).*cos(Tv).*sin(exYA).*sin(ezRA)+cos(eyRA).^2.*cos(ezRA).^2.*sin(exYA).*sin(ezYA)+cos(Tv).*sin(exYA).*sin(ezYA)-cos(eyRA).^2.*cos(ezRA).^2.*cos(Tv).*sin(exYA).*sin(ezYA)-cos(ezYA).*sin(exYA).*sin(eyRA).*sin(Tv)+cos(exYA).*cos(eyRA).*sin(ezRA).*sin(Tv)).*sin(Yv))+(cos(eyRA).^2.*cos(ezRA).^2.*(1-cos(Tv))+cos(Tv)).*((1-cos(Yv)).*(cos(exYA).*(cos(Tv)+(1-cos(Tv)).*sin(eyRA).^2)-cos(ezYA).*sin(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)+cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)-cos(eyRA).*sin(ezRA).*sin(Tv))).*((cos(eyRA).^2.*cos(ezRA).^2.*(1-cos(Tv))+cos(Tv)).*sin(exYA).*sin(ezYA)-cos(ezYA).*sin(exYA).*(cos(eyRA).^2.*cos(ezRA).*(1-cos(Tv)).*sin(ezRA)+sin(eyRA).*sin(Tv))+cos(exYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)+cos(eyRA).*sin(ezRA).*sin(Tv)))+(cos(ezYA).*cos(Tv).*sin(exYA)+cos(exYA).*cos(eyRA).*sin(eyRA).*sin(ezRA)-cos(exYA).*cos(eyRA).*cos(Tv).*sin(eyRA).*sin(ezRA)+cos(eyRA).^2.*cos(ezYA).*sin(exYA).*sin(ezRA).^2-cos(eyRA).^2.*cos(ezYA).*cos(Tv).*sin(exYA).*sin(ezRA).^2-cos(eyRA).^2.*cos(ezRA).*sin(exYA).*sin(ezRA).*sin(ezYA)+cos(eyRA).^2.*cos(ezRA).*cos(Tv).*sin(exYA).*sin(ezRA).*sin(ezYA)+cos(exYA).*cos(eyRA).*cos(ezRA).*sin(Tv)+sin(exYA).*sin(eyRA).*sin(ezYA).*sin(Tv)).*sin(Yv)))+(cos(eRxP).*cos(eRyY)+sin(eRxP).*sin(pi./4+eRzR).*sin(eRyY)).*((-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)+cos(eyRA).*cos(ezRA).*sin(Tv)).*(cos(Yv)+(1-cos(Yv)).*(cos(exYA).*(cos(Tv)+(1-cos(Tv)).*sin(eyRA).^2)-cos(ezYA).*sin(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)+cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)-cos(eyRA).*sin(ezRA).*sin(Tv))).^2)+(cos(Tv)+cos(eyRA).^2.*(1-cos(Tv)).*sin(ezRA).^2).*((1-cos(Yv)).*(-cos(ezYA).*sin(exYA).*(cos(Tv)+cos(eyRA).^2.*(1-cos(Tv)).*sin(ezRA).^2)+cos(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)-cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(cos(eyRA).^2.*cos(ezRA).*(1-cos(Tv)).*sin(ezRA)-sin(eyRA).*sin(Tv))).*(cos(exYA).*(cos(Tv)+(1-cos(Tv)).*sin(eyRA).^2)-cos(ezYA).*sin(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)+cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)-cos(eyRA).*sin(ezRA).*sin(Tv)))+(-cos(exYA).*cos(eyRA).*cos(ezRA).*sin(eyRA)+cos(exYA).*cos(eyRA).*cos(ezRA).*cos(Tv).*sin(eyRA)-cos(eyRA).^2.*cos(ezRA).*cos(ezYA).*sin(exYA).*sin(ezRA)+cos(eyRA).^2.*cos(ezRA).*cos(ezYA).*cos(Tv).*sin(exYA).*sin(ezRA)+cos(eyRA).^2.*cos(ezRA).^2.*sin(exYA).*sin(ezYA)+cos(Tv).*sin(exYA).*sin(ezYA)-cos(eyRA).^2.*cos(ezRA).^2.*cos(Tv).*sin(exYA).*sin(ezYA)-cos(ezYA).*sin(exYA).*sin(eyRA).*sin(Tv)+cos(exYA).*cos(eyRA).*sin(ezRA).*sin(Tv)).*sin(Yv))+(cos(eyRA).^2.*cos(ezRA).*(1-cos(Tv)).*sin(ezRA)+sin(eyRA).*sin(Tv)).*((1-cos(Yv)).*(cos(exYA).*(cos(Tv)+(1-cos(Tv)).*sin(eyRA).^2)-cos(ezYA).*sin(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)+cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)-cos(eyRA).*sin(ezRA).*sin(Tv))).*((cos(eyRA).^2.*cos(ezRA).^2.*(1-cos(Tv))+cos(Tv)).*sin(exYA).*sin(ezYA)-cos(ezYA).*sin(exYA).*(cos(eyRA).^2.*cos(ezRA).*(1-cos(Tv)).*sin(ezRA)+sin(eyRA).*sin(Tv))+cos(exYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)+cos(eyRA).*sin(ezRA).*sin(Tv)))+(cos(ezYA).*cos(Tv).*sin(exYA)+cos(exYA).*cos(eyRA).*sin(eyRA).*sin(ezRA)-cos(exYA).*cos(eyRA).*cos(Tv).*sin(eyRA).*sin(ezRA)+cos(eyRA).^2.*cos(ezYA).*sin(exYA).*sin(ezRA).^2-cos(eyRA).^2.*cos(ezYA).*cos(Tv).*sin(exYA).*sin(ezRA).^2-cos(eyRA).^2.*cos(ezRA).*sin(exYA).*sin(ezRA).*sin(ezYA)+cos(eyRA).^2.*cos(ezRA).*cos(Tv).*sin(exYA).*sin(ezRA).*sin(ezYA)+cos(exYA).*cos(eyRA).*cos(ezRA).*sin(Tv)+sin(exYA).*sin(eyRA).*sin(ezYA).*sin(Tv)).*sin(Yv)))+(cos(eRyY).*sin(eRxP)-cos(eRxP).*sin(pi./4+eRzR).*sin(eRyY)).*((cos(Tv)+(1-cos(Tv)).*sin(eyRA).^2).*(cos(Yv)+(1-cos(Yv)).*(cos(exYA).*(cos(Tv)+(1-cos(Tv)).*sin(eyRA).^2)-cos(ezYA).*sin(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)+cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)-cos(eyRA).*sin(ezRA).*sin(Tv))).^2)+(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)-cos(eyRA).*cos(ezRA).*sin(Tv)).*((1-cos(Yv)).*(-cos(ezYA).*sin(exYA).*(cos(Tv)+cos(eyRA).^2.*(1-cos(Tv)).*sin(ezRA).^2)+cos(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)-cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(cos(eyRA).^2.*cos(ezRA).*(1-cos(Tv)).*sin(ezRA)-sin(eyRA).*sin(Tv))).*(cos(exYA).*(cos(Tv)+(1-cos(Tv)).*sin(eyRA).^2)-cos(ezYA).*sin(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)+cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)-cos(eyRA).*sin(ezRA).*sin(Tv)))+(-cos(exYA).*cos(eyRA).*cos(ezRA).*sin(eyRA)+cos(exYA).*cos(eyRA).*cos(ezRA).*cos(Tv).*sin(eyRA)-cos(eyRA).^2.*cos(ezRA).*cos(ezYA).*sin(exYA).*sin(ezRA)+cos(eyRA).^2.*cos(ezRA).*cos(ezYA).*cos(Tv).*sin(exYA).*sin(ezRA)+cos(eyRA).^2.*cos(ezRA).^2.*sin(exYA).*sin(ezYA)+cos(Tv).*sin(exYA).*sin(ezYA)-cos(eyRA).^2.*cos(ezRA).^2.*cos(Tv).*sin(exYA).*sin(ezYA)-cos(ezYA).*sin(exYA).*sin(eyRA).*sin(Tv)+cos(exYA).*cos(eyRA).*sin(ezRA).*sin(Tv)).*sin(Yv))+(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)+cos(eyRA).*sin(ezRA).*sin(Tv)).*((1-cos(Yv)).*(cos(exYA).*(cos(Tv)+(1-cos(Tv)).*sin(eyRA).^2)-cos(ezYA).*sin(exYA).*(-cos(eyRA).*(1-cos(Tv)).*sin(eyRA).*sin(ezRA)+cos(eyRA).*cos(ezRA).*sin(Tv))+sin(exYA).*sin(ezYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)-cos(eyRA).*sin(ezRA).*sin(Tv))).*((cos(eyRA).^2.*cos(ezRA).^2.*(1-cos(Tv))+cos(Tv)).*sin(exYA).*sin(ezYA)-cos(ezYA).*sin(exYA).*(cos(eyRA).^2.*cos(ezRA).*(1-cos(Tv)).*sin(ezRA)+sin(eyRA).*sin(Tv))+cos(exYA).*(-cos(eyRA).*cos(ezRA).*(1-cos(Tv)).*sin(eyRA)+cos(eyRA).*sin(ezRA).*sin(Tv)))+(cos(ezYA).*cos(Tv).*sin(exYA)+cos(exYA).*cos(eyRA).*sin(eyRA).*sin(ezRA)-cos(exYA).*cos(eyRA).*cos(Tv).*sin(eyRA).*sin(ezRA)+cos(eyRA).^2.*cos(ezYA).*sin(exYA).*sin(ezRA).^2-cos(eyRA).^2.*cos(ezYA).*cos(Tv).*sin(exYA).*sin(ezRA).^2-cos(eyRA).^2.*cos(ezRA).*sin(exYA).*sin(ezRA).*sin(ezYA)+cos(eyRA).^2.*cos(ezRA).*cos(Tv).*sin(exYA).*sin(ezRA).*sin(ezYA)+cos(exYA).*cos(eyRA).*cos(ezRA).*sin(Tv)+sin(exYA).*sin(eyRA).*sin(ezYA).*sin(Tv)).*sin(Yv))))));
    
    lambda_m=abs(2*Lattice*sin(pi/2-angolo)./sqrt(h.^2+k.^2+l.^2)/norder);
    photon_energy_ev = hplanck*cluce./lambda_m; 
    angolo=angolo*180/pi;
    lambda_m=abs(lambda_m);
end





